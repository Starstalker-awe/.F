<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta charset="UTF-8">
		<title>Grocery List</title>
		<style>
			:root{
				--width: 75%;
				--content-width: 85%;
				--rainbow: linear-gradient(90deg, red, orange, yellow, lime, green, lightblue, blue, purple);
				--ingredient-height: 25px;
			}
			body{font-family: 'Work Sans', sans-serif;}
			.toggles{
				display: flex;
				justify-content: center;
				flex-direction: column;
			}
			.divider{
				width: var(--width);
				height: 2px;
				background-image: var(--rainbow);
				margin: 0 auto;
			}
			.toggle-title, .meal{
				color: #444;
				cursor: pointer;
				padding: 20px 20px 10px 20px;
				width: var(--width);
				outline: none;
				margin: auto;
			}
			input.meal{width: 60% !important;}
			.toggle-title:after{
				content: '\02795';
				font-size: 13px;
				color: #777;
				float: right;
				margin-left: 5px;
			}
			.toggle-body{
				margin: auto auto 10px auto;
				width: var(--content-width);
				background-color: white;
				display: none;
				outline: 1px solid grey;
				overflow: hidden;
				padding: 5px;
			}
			.active:after{content: "\2796";}

			.banner-button{
				width: 100%;
				height: 60px;
				border-radius: 3px;
				text-align: center;
				margin: 0 auto;
			}
			.create-meal{
				border: 2px solid rgb(255, 140, 0);
				background-color: rgba(255, 140, 0, 0.228);
			}
			.ingredients{
				margin: 20px 0;
			}
			.ingredient, .ingredient-right{
				display: flex;
				flex-wrap: nowrap;
				justify-content: space-between;
			}
			.ingredient, .ingredient>p{
				min-height: var(--ingredient-height);
			}
			.ingredient-right{
				justify-content: flex-end;
				width: 50%;
			}
			input{
				width: 15%;
			}
			select{
				width: 20%;
				flex-grow: 1;
				
			}
			.ingredient>p{
				width: 30%;
				flex-grow: 1;
				font-size: 13px;
				margin: calc(var(--ingredient-height) / 4) 10px;
			}

			.meal-container{
				margin: 5px;
				padding: 5px;
				outline: 1px solid black;
			}


			.inline{display: inline;}
			.flex{display: flex;}
		</style>
	</head>
	<body>
		<main>
			<section class="toggles">
				<div id="meals-container">
					<h2 class="toggle-title">Meals</h2>
					<div class="toggle-body">
						<div id="meals">

						</div>
						<button class="banner-button create-meal">New Meal</button>
					</div>
				</div>
				<div class="divider"></div>
				<div id="meal-plan-container">
					<h2 class="toggle-title">Menu Plan</h2>
					<div class="toggle-body">
						<p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit saepe sequi, illum facere
							necessitatibus cum aliquam id illo omnis maxime, totam soluta voluptate amet ut sit ipsum
							aperiam.
							Perspiciatis, porro!</p>
					</div>
				</div>
				<div class="divider"></div>
				<div id="grocery-list-container">
					<h2 class="toggle-title">Grocery List</h2>
					<div class="toggle-body">
						<p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit saepe sequi, illum facere
							necessitatibus cum aliquam id illo omnis maxime, totam soluta voluptate amet ut sit ipsum
							aperiam.
							Perspiciatis, porro!</p>
					</div>
				</div>
			</section>
		</main>
		<script type="module">
			import {source as s, render, template} from 'https://unpkg.com/@lcf.vs/dom-engine@5.5.4/lib/frontend.js';
			String.prototype.format = function(_=0){return (_ = this.trim()).length > 1 ? _.split(" ").map(w=>(w = w.trim(), `${w[0].toUpperCase()}${w.substring(1).toLowerCase()}`)).join(" ") : _.length == 1 ? _.toUpperCase() : _};
			NodeList.prototype.addEventListener = function(event, func){return [...this].map(node=>node.addEventListener(event, func))};
			Node.prototype.p = function(c=1,_){return (_ = this, Array.from(Array(c),_=>0).forEach(n=>_ = _.parentNode), _)};
			
			class Meal{
				constructor({name, ingredients}){
					this.name = name; 
					this.ingredients = ingredients;
				}
				serialize(){return {name: this.name, ingredients: this.ingredients.serialize()}}
				render(){
					return render({
						[s]: `<div class="meal-container" data-meal-name="{name}">
							<h3 class="meal inline">{name}</h3>
							<span class="edit-meal-name inline" data-editing="false">âœŽ</span>
							<span class="meal-delete inline">ðŸ—‘</span>
							<div class="ingredients">
								{ingredients}
							</div>
							<button class="banner-button add-ingredient">Add Ingredient</button>
						</div>`,
						name: this.name,
						ingredients: this.ingredients.items.map(i=>i.render()),
					})
				}
			}
			class Ingredient{
				#cat; constructor(name, qty, cat){
					this.name = name; 
					this.qty = qty;
					this.#cat = cat;
					return (_=>new Proxy(_, {
						get(targ, prop){return prop === 'category' ? (typeof _.#cat === 'number' ? Ingredient.categories[_.#cat] : _.#cat) : targ[prop]},
						set(targ, prop, val){return targ[prop] = prop === 'category' ? (typeof val === 'number' ? Ingredient.categories[val] : val) : val; return !0}
					}))(this)
				}
				serialize(){return {...this, category: typeof this.category == 'number' ? this.category : Ingredient.categories.indexOf(this.category)}}
				render(){
					return render({
						[s]: `<div class="ingredient" data-ingredient-name="${this.name}">
							<p contenteditable>${this.name}</p>
							<div class="ingredient-right">
								<input type="number" value="${this.qty}" class="ingredient-qty"></input>
								<select class="ingredient-categories">
									<option class="ingredient-category" disabled>-- ${this.name} --</option>
									{categories}
								</select>
								<button class="ingredient-delete">ðŸ—‘</button>
							</div>
						</div>`,
						categories: Ingredient.categories.map((c,i)=>render({
							[s]: `<option class="ingredient-category" ${Ingredient.categories.indexOf(this.category) == i ? 'selected ' : ''}value="${c}">${c}</option>`
						}))
					})
				}
				static categories = ["Dry", "Produce", "Deli", "Frozen", "Other"];
			}
			class Day{
				#day; #meal; constructor(day, meal){
					this.#meal = meal;
					this.#day = day;
					return (_=>new Proxy(_, {
						get(targ, prop){return prop === 'day' ? (typeof _.#day === 'number' ? Day.days[_.#day] : _.#day) : prop === 'meal' ? data.meals.find(_.#meal) : targ[prop]},
						set(targ, prop, val){return targ[prop] = prop === 'day' ? (typeof val === 'number' ? Day.days[val] : val) : val}
					}))(this)
				}
				static days = {0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday'}
			}

			class List{
				#ltype; constructor(...items){this.items = items.flat(); this.#ltype = this.constructor.name}
				find(name, _=0){return (_ = this.items.find(i=>i.name.format() === (name ?? '').format())) ? new Proxy(_, {}) : null}
				remove(name, _=0){return ((_ = this.items.reduce((p,c,i)=>c.name.format() === name.format() ? i : p, null)) !== null ? this.items.splice(_, 1) : null, this.items)}
				add(item, hrs, _=0){return (_ = this.items.reduce((p,c,i)=>c.name.format() === item.name.format() ? i : p, 0)) ? hrs[0](this, _, item) : hrs[1](this, item)}
				serialize(){return this.items.map(i=>i.serialize())}
				last(){return this.items[this.items.length - 1]}
			}

			class MealList extends List{
				constructor(...meals){super(...meals.flat())}
				add(meal){return super.add(meal, [(t,i,i2)=>alert("You've already defined a meal with that name!"), (t,i2)=>t.items.push(i2)])}
			}
			class IngredientList extends List{
				constructor(...ingredients){super(...ingredients.flat())}
				add(ingredient){return super.add(ingredient, [(t,i,i2)=>t.items[i].qty += i2.qty, (t,i2)=>t.items.push(i2)])}
			}
			class Week extends List{
				constructor(...days){super(...(days.length ? days.flat() : Array.from(Array(7), (_,i)=>new Day(i, null))))}
				add(day){return super.add(day, [(..._)=>null, (t,i2)=>t.items.push(i2)])}
			}


			// ========= TEST DATA =============
			const things = {
				meals: new MealList(
					new Meal({
						name: "Pesto Pasta", 
						ingredients: new IngredientList(
							new Ingredient("Pasta", 1, 0), 
							new Ingredient("Spinach", 0.5, 1), 
							new Ingredient("Pesto", 0.5, 0), 
							new Ingredient("Pepper", 1, 1), 
							new Ingredient("Olives", 0.5, 0)
						)
					}),
					new Meal({
						name: "Lentil Pasta", 
						ingredients: new IngredientList(
							new Ingredient("Pasta", 1, 0), 
							new Ingredient("Carrot", 1, 1), 
							new Ingredient("Lentil", 1, 0)
						)
					}),
					new Meal({
						name: "A really really really really really long meal name", 
						ingredients: new IngredientList(
							new Ingredient("A really really really really long ingredient name", 1)
						)
					})
				), 
				plan: [new Week()], 
				list: new Set()};
			window.localStorage.setItem("meal_plan_data", JSON.stringify({plan: thins.plan.map(week=>week.serialize()), list: [...things.list], meals: things.meals.serialize()}));
			// ========= TEST DATA =============

			for (const title of document.querySelectorAll(".toggle-title")){
				title.addEventListener("click", e=>{
					title.classList.toggle("active");
					const n = title.nextElementSibling;
					if (n.style.display === 'block'){
						n.style.display = 'none';
					}else{
						n.style.display = 'block';
					}
				})
			}

			let data = JSON.parse(window.localStorage.getItem("meal_plan_data") ?? {meals: [], plan: [], list: new Set()});

			await new Promise(res=>{
				const obj = {
					meals: new MealList(
						...data.meals.map(meal=>
							new Meal({
								...meal, 
								ingredients: new IngredientList(
									...meal.ingredients.map(ingredient=>
										new Ingredient(...Object.values(ingredient))))}))),
					plan: data.plan.map(week=>new Week(...week)),
					list: new Set(data.list)
				};
				res(Object.assign(data, obj));
			})
			.then(_=>data.meals.items.forEach(meal=>document.querySelector("#meals").append(meal.render())))
			.then(_=>{ // Define listener functions as global
				window.ingredientName = function(e){
					const [el, nname] = [e.target, e.target.textContent];
					data.meals.find(el.p(3).dataset.mealName).ingredients.find(el.p().dataset.ingredientName).name = nname;
					el.p().dataset.ingredientName = nname
				}
				window.ingredientQty = function(e){const el = e.target; data.meals.find(el.p(4).dataset.mealName).ingredients.find(el.p(2).dataset.ingredientName).qty = Number(el.value)}
				window.ingredientCategory = function(e){const el = e.target; data.meals.find(el.p(4).dataset.mealName).ingredients.find(el.p(2).dataset.ingredientName).category = el.value}
				window.ingredientDelete = function(e){
					const el = e.target.p(2);
					if (confirm(`Are you sure you want to delete ${el.dataset.ingredientName} from ${el.p(2).dataset.mealName} ingredient list?`)){
						data.meals.find(el.p(2).dataset.mealName).ingredients.remove(el.dataset.ingredientName);
						el.remove()
					}
				}

				window.addIngredient = function(e){
					const ingredients = data.meals.find(e.target.p().dataset.mealName).ingredients;
					if (ingredients.last().name.format() !== 'Something'){
						ingredients.add(new Ingredient("Something", 0, 4));
						e.target.p().querySelector(".ingredients").append(ingredients.find("Something").render())
						const el = document.querySelector(`.meal-container[data-meal-name="${e.target.p().dataset.mealName}"] .ingredient:last-child`);

						el.querySelector(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
						el.querySelector(".ingredient-qty").addEventListener("input", window.ingredientQty);
						el.querySelector(".ingredient-categories").addEventListener("change", window.ingredientCategory);
						el.querySelector(".ingredient-delete").addEventListener("click", window.ingredientDelete);
					}else{alert("Please change the name of 'Something' to add another ingredient!")}
				}
				window.changeMealName = function(e){
					const toggle = e.target.dataset.editing = !(e.target.dataset.editing == 'true');
					e.target.innerHTML = toggle ? 'ðŸ’¾' : 'âœŽ';
					const name = e.target.previousElementSibling;
					if (toggle){
						const replacer = Object.assign(document.createElement("input"), {value: name.innerHTML, classList: "meal inline"});
						name.p().replaceChild(replacer, name);
						replacer.addEventListener('focus', e=>e.target.selectionStart = e.target.selectionEnd = e.target.value.length);
						replacer.focus();
					}else{
						const replacer = Object.assign(document.createElement("h3"), {innerHTML: name.value, classList: "meal inline"});
						name.p().replaceChild(replacer, name);
						if (!data.meals.find(name.value) || name.value === replacer.p().dataset.mealName){
							data.meals.find(replacer.p().dataset.mealName).name = replacer.p().dataset.mealName = name.value;
						}else{
							alert("You've already defined a meal with that name!");
							replacer.innerHTML = replacer.p().dataset.mealName;
						}
					}
				}
				window.deleteMeal = function(e){
					const el = e.target.p();
					if (confirm(`Are you sure you want to delete "${el.dataset.mealName}" from your meal list?`)){
						data.meals.remove(el.dataset.mealName); el.remove()
					}
				}
			})
			.then(_=>{
				document.querySelectorAll(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
				document.querySelectorAll(".ingredient-qty").addEventListener("input", window.ingredientQty);
				document.querySelectorAll(".ingredient-categories").addEventListener("change", window.ingredientCategory);
				document.querySelectorAll(".ingredient-delete").addEventListener("click", window.ingredientDelete);
				document.querySelectorAll(".edit-meal-name").addEventListener("click", window.changeMealName);
				document.querySelectorAll(".meal-delete").addEventListener("click", window.deleteMeal);
				
				document.querySelectorAll(".add-ingredient").addEventListener("click", window.addIngredient);
			})
			.then(_=>{
				document.querySelector("button.create-meal").addEventListener("click", function(e){
					if(data.meals.last().name.format() !== 'Something'){
						data.meals.add(new Meal({name: 'Something', ingredients: new IngredientList(new Ingredient("Something", 0, 4))}))
						e.target.p().querySelector("#meals").append(data.meals.last().render());
						const el = document.querySelector("#meals .meal-container:last-child");

						el.querySelector(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
						el.querySelector(".ingredient-qty").addEventListener("input", window.ingredientQty);
						el.querySelector(".ingredient-categories").addEventListener("change", window.ingredientCategory);
						el.querySelector(".ingredient-delete").addEventListener("click", window.ingredientDelete);
						el.querySelector(".edit-meal-name").addEventListener("click", window.changeMealName);
						el.querySelector(".meal-delete").addEventListener("click", window.deleteMeal);

						el.querySelector(".add-ingredient").addEventListener("click", window.addIngredient);
					}else{alert("Please change the name of 'Something' to add another meal!")}
				})
			})

			window.log = function(){return data.meals}
		</script>
	</body>
</html>