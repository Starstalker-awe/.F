<!DOCTYPE html>
<html lang="en-US">
	<head>
		<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
		<script src="https://unpkg.com/babel-standalone@6/babel.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta charset="UTF-8">
		<title>Grocery List</title>
		<style>
			:root{
				--width: 75%;
				--content-width: 85%;
				--rainbow: linear-gradient(90deg, red, orange, yellow, lime, green, lightblue, blue, purple);
				--ingredient-height: 25px;
			}
			body{font-family: 'Work Sans', sans-serif;}
			.toggles{
				display: flex;
				justify-content: center;
				flex-direction: column;
			}
			.divider{
				width: var(--width);
				height: 2px;
				background-image: var(--rainbow);
				margin: 0 auto;
			}
			.toggle-title, .meal{
				color: #444;
				cursor: pointer;
				padding: 20px 20px 10px 20px;
				width: var(--width);
				outline: none;
				margin: auto;
			}
			input.meal{width: 60% !important;}
			.toggle-title:after{
				content: '\02795';
				font-size: 13px;
				color: #777;
				float: right;
				margin-left: 5px;
			}
			.toggle-body{
				margin: auto auto 10px auto;
				width: var(--content-width);
				background-color: white;
				display: none;
				outline: 1px solid grey;
				overflow: hidden;
				padding: 5px;
			}
			.active:after{content: "\2796";}

			.banner-button{
				width: 100%;
				height: 60px;
				border-radius: 3px;
				text-align: center;
				margin: 0 auto;
			}
			.create-meal{
				border: 2px solid rgb(255, 140, 0);
				background-color: rgba(255, 140, 0, 0.228);
			}
			.ingredients{
				margin: 20px 0;
			}
			.ingredient, .ingredient-right{
				display: flex;
				flex-wrap: nowrap;
				justify-content: space-between;
			}
			.ingredient, .ingredient>p{
				min-height: var(--ingredient-height);
			}
			.ingredient-right{
				justify-content: flex-end;
				width: 50%;
			}
			input{
				width: 15%;
			}
			select{
				width: 20%;
				flex-grow: 1;
				
			}
			.ingredient>p{
				width: 30%;
				flex-grow: 1;
				font-size: 13px;
				margin: calc(var(--ingredient-height) / 4) 10px;
			}

			.meal-container{
				margin: 5px;
				padding: 5px;
				outline: 1px solid black;
			}


			.inline{display: inline;}
			.flex{display: flex;}
		</style>
	</head>
	<body>
		<main id="root"></main>
		<script type="text/babel">
			String.prototype.format = function(_=0){return (_ = this.trim()).length > 1 ? _.split(" ").map(w=>(w = w.trim(), `${w[0].toUpperCase()}${w.substring(1).toLowerCase()}`)).join(" ") : _.length == 1 ? _.toUpperCase() : _};
			const ListContext = React.createContext();

			class List extends React.Component{
				constructor(props){
					super(props);
					this.state = {items: props.children}
				}

				findIndex=n=>this.state.items.reduce((p,c,i)=>c.props.name.format() === n.format() ? i : p, null);

				remove=e=>confirm(`Are you sure you want to remove ${e.target.dataset.name} from ${e.target.dataset.parent}?`) ? (this.state.items.splice(this.findIndex(e.target.dataset.name), 1), this.forceUpdate()) : false;
				//add=(...is)=>(is.flat().map(i=>this.state.items.splice(this.state.items.length, 0, i)), this);
				add=e=>{
					const item = {...this.state.items[0], props: {name: "New ...", ingredients: [{name: "New ingredient", qty: 0, category: 0}]}, key: `${this.state.items[0].key.split("_")[0]}_${this.state.items.length}`}
					this.state.items.push(item);
					this.forceUpdate();
				}
				rename=(o,n)=>this.findIndex(n) === null ? (this.state.items[this.findIndex(o)].props.name = n, true) : false;

				render=()=>{
					return (
						<div className="list-content" id={this.props.id}>
							<ListContext.Provider value={{remove: this.remove, add: this.add, rename: this.rename}}>
								{this.props.children}
							</ListContext.Provider>
							<button className="banner-button" id={`new-${this.props.button}`} onClick={this.add}>New {this.props.button.format()}</button>
						</div>
					)
				}
			}

			class Ingredient extends React.Component{
				constructor(props){
					super(props);
					this.state = {
						name: props.name,
						_name: props.name,
						qty: props.qty,
						category: typeof props.category === 'string' ? props.category.format() : Ingredient.categories[props.category],
						editing: false
					}
				}

				serialize(){return {name: this.state.name, qty: this.state.qty, category: Ingredient.categories.indexOf(this.state.category.format())}}

				render=()=>{
					return (
						<ListContext.Consumer>
							{value=>(
								<div className="ingredient">
									<p contentEditable={this.state.editing} onInput={e=>this.setState({_name: e.target.innerHTML})}>{this.state.name.format()}</p>
									<span className="edit-ingredient-name inline" onClick={e=>{
										this.setState({editing: !this.state.editing});
										console.log(e.target.parentElement)
										if(this.state.editing){
											if(!value.rename(this.state.name, this.state._name)){
												this.setState({_name: this.state.name})
												alert(`You've already used the name "${this.state._name.format()}"!`);
												console.log(this.state.name, this.state._name)
												this.forceUpdate();
											}else{this.setState({name: this.state._name})}
										}
									}}>âœŽ</span>
									<div className="ingredient-right">
										<input type="number" value={this.state.qty} className="ingredient-qty" onInput={e=>this.setState({qty: e.target.value})}></input>
										<select className="ingredient-categories" onChange={e=>this.setState({category: e.target.value})}>
											<option key="cat_0" className="ingredient-category" disabled selected={this.state.category !== null}>-- {this.state.name} --</option>
											{Ingredient.categories.map((c,i)=>(
												<option key={`cat_${i+1}`} className="ingredient-category" value={c} selected={Ingredient.categories.indexOf(this.state.category) === i}>{c}</option>
											))}
										</select>
										<button className="ingredient-delete" data-name={this.state.name} data-parent={this.props.meal} onClick={value.remove}>ðŸ—‘</button>
									</div>
								</div>)}
						</ListContext.Consumer>
					)
				}

				static categories = ["Dry", "Produce", "Deli", "Frozen", "Other"];
			}

			class Meal extends React.Component{
				constructor(props){
					super(props);
					this.state = {
						name: props.name, 
						_name: props.name, 
						ingredients: props.ingredients,
						editing: false
					}
				}

				serialize(){return {name: this.state.name, ingredients: this.ingredients.map(i=>i.serialize())}}

				render=_=>{
					return (
						<div className="meal-container">
							<h3 className="meal inline" contentEditable={this.state.editing} onInput={e=>this.setState({_name: e.target.innerHTML})}>{this.state.name}</h3>
							<ListContext.Consumer>
								{value=>(
									<span className="meal-name-buttons">
										<span className="edit-meal-name inline" onClick={e=>{
											this.setState({editing: !this.state.editing});
											if(this.state.editing){
												if(!value.rename(this.state.name, this.state._name)){
													this.setState({_name: this.state.name})
													alert(`You've already used the name "${this.state._name.format()}"!`);
													this.forceUpdate();
												}else{this.setState({name: this.state._name})}
											}
										}}>âœŽ</span>
										<span className="meal-delete inline" data-name={this.state.name} data-parent="meals" onClick={value.remove}>ðŸ—‘</span>
									</span>
								)}
							</ListContext.Consumer>
							<List button="ingredient">
								{this.state.ingredients.map((d,i)=>(
									<Ingredient key={`ingredient_${i}`} name={d.name} qty={d.qty} category={d.category} parent={this.state.name} />
								))}
							</List>
						</div>
					)
				}
			}

			class Dropdown extends React.Component{
				constructor(props){
					super(props);
					this.state = {open: props.open || false}
				}

				drop=_=>{this.setState({open: !this.state.open})}
				render=()=>{
					return (
						<div className="toggleable">
							<h2 className={"toggle-title" + (this.state.open ? " open" : "")} onClick={this.drop}>{this.props.title}</h2>
							<div className="toggle-body" style={{display: this.state.open ? 'block' : 'none'}}>
								{this.props.children}
							</div>
						</div>
					)
				}
			}

			// ====== TEST DATA ======
			window.localStorage.setItem("data", JSON.stringify({
				meals: [
					{
						name: 'Pesto Pasta',
						ingredients: [
							{name: 'Pasta', qty: 1, category: "Dry"},
							{name: 'Spinach', qty: 0.5, category: "Produce"},
							{name: 'Pesto', qty: 0.5, category: "Dry"},
							{name: "Pepper", qty: 1, category: "Produce"},
							{name: "Olives", qty: 0.5, category: "Dry"}
						]
					},
					/*{
						name: 'Lentil Pasta',
						ingredients: [
							{name: "Pasta", qty: 1, category: "Dry"},
							{name: "Carrot", qty: 1, category: "Produce"},
							{name: "Lentil", qty: 1, category: "Dry"}
						]
					}*/
				]
			}))
			// ====== TEST DATA ======

			const data = JSON.parse(window.localStorage.getItem("data"))
			ReactDOM.render(
				<section className="toggles">
					<Dropdown title="Meals" open={true}>
						<List id='meals' button='meal'>
							{data.meals.map((m,i)=><Meal key={`meal_${i}`} name={m.name} ingredients={m.ingredients} />)}
						</List>
					</Dropdown>
					<div className="divider" />
					<Dropdown title="Menu Plan">
						<List id='meals' button='meal'>
							{}
						</List>
					</Dropdown>
					<div className="divider" />
					<Dropdown title="Grocery List">
						<List id="grocery-list" button="item">
							{}
						</List>
					</Dropdown>
				</section>,
				document.querySelector("#root")
			)
		</script>
		<!--<script type="module">
			import {source as s, render, template} from 'https://unpkg.com/@lcf.vs/dom-engine@5.5.4/lib/frontend.js';
			String.prototype.format = function(_=0){return (_ = this.trim()).length > 1 ? _.split(" ").map(w=>(w = w.trim(), `${w[0].toUpperCase()}${w.substring(1).toLowerCase()}`)).join(" ") : _.length == 1 ? _.toUpperCase() : _};
			NodeList.prototype.addEventListener = function(event, func){return [...this].map(node=>node.addEventListener(event, func))};
			Node.prototype.p = function(c=1,_){return (_ = this, Array.from(Array(c),_=>0).forEach(n=>_ = _.parentNode), _)};
			
			class Meal{
				constructor({name, ingredients}){
					this.name = name; 
					this.ingredients = ingredients;
					return (_=>new Proxy(_, {
						set(targ, prop, val){[...document.querySelectorAll("*")].forEach(e=>e.dispatchEvent(new Event("rerender options"))); return targ[prop] = val}
					}))(this)
				}
				serialize(){return {name: this.name, ingredients: this.ingredients.serialize()}}
				render(){
					return render({
						[s]: `<div class="meal-container" data-meal-name="{name}">
							<h3 class="meal inline">{name}</h3>
							<span class="edit-meal-name inline" data-editing="false">âœŽ</span>
							<span class="meal-delete inline">ðŸ—‘</span>
							<div class="ingredients">
								{ingredients}
							</div>
							<button class="banner-button add-ingredient">Add Ingredient</button>
						</div>`,
						name: this.name,
						ingredients: this.ingredients.items.map(i=>i.render()),
					})
				}
			}
			class Ingredient{
				#cat; constructor(name, qty, cat){
					this.name = name; 
					this.qty = qty;
					this.#cat = cat;
					return (_=>new Proxy(_, {
						get(targ, prop){return prop === 'category' ? (typeof _.#cat === 'number' ? Ingredient.categories[_.#cat] : _.#cat) : targ[prop]},
						set(targ, prop, val){return targ[prop] = prop === 'category' ? (typeof val === 'number' ? Ingredient.categories[val] : val) : val; return !0}
					}))(this)
				}
				serialize(){return {...this, category: typeof this.category == 'number' ? this.category : Ingredient.categories.indexOf(this.category)}}
				render(){
					return render({
						[s]: `<div class="ingredient" data-ingredient-name="${this.name}">
							<p contenteditable>${this.name}</p>
							<div class="ingredient-right">
								<input type="number" value="${this.qty}" class="ingredient-qty"></input>
								<select class="ingredient-categories">
									<option class="ingredient-category" disabled>-- ${this.name} --</option>
									{categories}
								</select>
								<button class="ingredient-delete">ðŸ—‘</button>
							</div>
						</div>`,
						categories: Ingredient.categories.map((c,i)=>render({
							[s]: `<option class="ingredient-category" ${Ingredient.categories.indexOf(this.category) == i ? 'selected ' : ''}value="${c}">${c}</option>`
						}))
					})
				}
				static categories = ["Dry", "Produce", "Deli", "Frozen", "Other"];
			}
			class Day{
				#day; #meal; constructor(day, meal){
					this.#day = day;
					this.#meal = meal;
					return (_=>new Proxy(_, {
						get(targ, prop){return prop === 'day' ? (typeof _.#day === 'number' ? Day.days[_.#day] : _.#day) : prop === 'meal' ? (window.data?.meals?.find(_.#meal) ?? _.#meal) : targ[prop]},
						set(targ, prop, val){return targ[prop] = prop === 'day' ? (typeof val === 'number' ? Day.days[val] : val) : val}
					}))(this)
				}
				serialize(){return [Object.keys(Day.days).reduce((p,c)=>Day.days[c] === this.day ? c : p, null), this.meal?.name ?? this.meal]}
				render(meals,_=0){
					return (_ = render({
						[s]: `<li class="meal-plan-day">
							<span class="meal-plan-day-left">{day}</span>
							<span class="meal-plan-day-right">
								<select class="meal-selector">
									{options}
								</select>
							</span>
						</li>`,
						options: Day.options(meals)
					}),
					_.addEventListener("rerender options", _=>_.target.querySelector("select").innerHTMl = Day.options(meals)), _)
				}
				static options(data){}
				static days = {0: 'Sunday', 1: 'Monday', 2: 'Tuesday', 3: 'Wednesday', 4: 'Thursday', 5: 'Friday', 6: 'Saturday'}
			}

			class List{
				#ltype; constructor(...items){this.items = items.flat(); this.#ltype = this.constructor.name}
				find(name, _=0){return (_ = this.items.find(i=>i.name.format() === (name ?? '').format())) ? new Proxy(_, {}) : null}
				remove(name, _=0){return ((_ = this.items.reduce((p,c,i)=>c.name.format() === name.format() ? i : p, null)) !== null ? this.items.splice(_, 1) : null, this.items)}
				add(item, hrs, _=0){return (_ = this.items.reduce((p,c,i)=>c.name.format() === item.name.format() ? i : p, 0)) ? hrs[0](this, _, item) : hrs[1](this, item)}
				serialize(){return this.items.map(i=>i.serialize())}
				last(){return this.items[this.items.length - 1]}
			}

			class MealList extends List{
				constructor(...meals){super(...meals.flat())}
				add(meal){return super.add(meal, [(t,i,i2)=>alert("You've already defined a meal with that name!"), (t,i2)=>t.items.push(i2)])}
			}
			class IngredientList extends List{
				constructor(...ingredients){super(...ingredients.flat())}
				add(ingredient){return super.add(ingredient, [(t,i,i2)=>t.items[i].qty += i2.qty, (t,i2)=>t.items.push(i2)])}
			}
			class Week extends List{
				constructor(...days){super(...(days.length ? days.flat() : Array.from(Array(7), (_,i)=>new Day(i, null))))}
				add(day){return super.add(day, [(..._)=>null, (t,i2)=>t.items.push(i2)])}
				render(passdown){
					return render({
						[s]: `<div class="week">
							<ul class="week-days-list">
								{days}
							</ul>
						</div>`,
						days: this.items.map(i=>i.render(passdown))
					})
				}
			}


			// ========= TEST DATA =============
			const things = {
				meals: new MealList(
					new Meal({
						name: "Pesto Pasta", 
						ingredients: new IngredientList(
							new Ingredient("Pasta", 1, 0), 
							new Ingredient("Spinach", 0.5, 1), 
							new Ingredient("Pesto", 0.5, 0), 
							new Ingredient("Pepper", 1, 1), 
							new Ingredient("Olives", 0.5, 0)
						)
					}),
					new Meal({
						name: "Lentil Pasta", 
						ingredients: new IngredientList(
							new Ingredient("Pasta", 1, 0), 
							new Ingredient("Carrot", 1, 1), 
							new Ingredient("Lentil", 1, 0)
						)
					}),
					new Meal({
						name: "A really really really really really long meal name", 
						ingredients: new IngredientList(
							new Ingredient("A really really really really long ingredient name", 1)
						)
					})
				), 
				plan: [new Week()], 
				list: new Set(),
				serialize(){
					return JSON.stringify({plan: this.plan.map(w=>w.serialize()), list: [...this.list], meals: this.meals.serialize()})
				}
			};
			window.localStorage.setItem("meal_plan_data", things.serialize());
			document.querySelector(".toggle-title").addEventListener("rerender options", _=>console.log("Rerender!"));
			console.log("Potat:", Day.options());
			// ========= TEST DATA =============

			for (const title of document.querySelectorAll(".toggle-title")){
				title.addEventListener("click", e=>{
					title.classList.toggle("active");
					const n = title.nextElementSibling;
					if (n.style.display === 'block'){
						n.style.display = 'none';
					}else{
						n.style.display = 'block';
					}
				})
			}

			window.data = JSON.parse(window.localStorage.getItem("meal_plan_data") ?? {});

			await new Promise(res=>{
				const obj = {
					meals: new MealList(
						...data.meals.map(meal=>
							new Meal({
								...meal, 
								ingredients: new IngredientList(
									...meal.ingredients.map(ingredient=>
										new Ingredient(...Object.values(ingredient))))}))),
					plan: data.plan.map(week=>new Week(...week)),
					list: new Set(data.list)
				};
				res(Object.assign(data, obj));
			})
			.then(_=>data.meals.items.forEach(meal=>document.querySelector("#meals").append(meal.render())))
			.then(_=>data.plan.forEach(week=>document.querySelector("#meal-plan-weeks").append(week.render(new Proxy(data.meals, {})))))
			.then(_=>{ // Define listener functions as global
				window.ingredientName = function(e){
					const [el, nname] = [e.target, e.target.textContent];
					data.meals.find(el.p(3).dataset.mealName).ingredients.find(el.p().dataset.ingredientName).name = nname;
					el.p().dataset.ingredientName = nname
				}
				window.ingredientQty = function(e){const el = e.target; data.meals.find(el.p(4).dataset.mealName).ingredients.find(el.p(2).dataset.ingredientName).qty = Number(el.value)}
				window.ingredientCategory = function(e){const el = e.target; data.meals.find(el.p(4).dataset.mealName).ingredients.find(el.p(2).dataset.ingredientName).category = el.value}
				window.ingredientDelete = function(e){
					const el = e.target.p(2);
					if (confirm(`Are you sure you want to delete ${el.dataset.ingredientName} from ${el.p(2).dataset.mealName} ingredient list?`)){
						data.meals.find(el.p(2).dataset.mealName).ingredients.remove(el.dataset.ingredientName);
						el.remove()
					}
				}

				window.addIngredient = function(e){
					const ingredients = data.meals.find(e.target.p().dataset.mealName).ingredients;
					if (ingredients.last().name.format() !== 'Something'){
						ingredients.add(new Ingredient("Something", 0, 4));
						e.target.p().querySelector(".ingredients").append(ingredients.find("Something").render())
						const el = document.querySelector(`.meal-container[data-meal-name="${e.target.p().dataset.mealName}"] .ingredient:last-child`);

						el.querySelector(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
						el.querySelector(".ingredient-qty").addEventListener("input", window.ingredientQty);
						el.querySelector(".ingredient-categories").addEventListener("change", window.ingredientCategory);
						el.querySelector(".ingredient-delete").addEventListener("click", window.ingredientDelete);
					}else{alert("Please change the name of 'Something' to add another ingredient!")}
				}
				window.changeMealName = function(e){
					const toggle = e.target.dataset.editing = !(e.target.dataset.editing == 'true');
					e.target.innerHTML = toggle ? 'ðŸ’¾' : 'âœŽ';
					const name = e.target.previousElementSibling;
					if (toggle){
						const replacer = Object.assign(document.createElement("input"), {value: name.innerHTML, classList: "meal inline"});
						name.p().replaceChild(replacer, name);
						replacer.addEventListener('focus', e=>e.target.selectionStart = e.target.selectionEnd = e.target.value.length);
						replacer.focus();
					}else{
						const replacer = Object.assign(document.createElement("h3"), {innerHTML: name.value, classList: "meal inline"});
						name.p().replaceChild(replacer, name);
						if (!data.meals.find(name.value) || name.value === replacer.p().dataset.mealName){
							data.meals.find(replacer.p().dataset.mealName).name = replacer.p().dataset.mealName = name.value;
						}else{
							alert("You've already defined a meal with that name!");
							replacer.innerHTML = replacer.p().dataset.mealName;
						}
					}
				}
				window.deleteMeal = function(e){
					const el = e.target.p();
					if (confirm(`Are you sure you want to delete "${el.dataset.mealName}" from your meal list?`)){
						data.meals.remove(el.dataset.mealName); el.remove()
					}
				}
			})
			.then(_=>{
				document.querySelectorAll(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
				document.querySelectorAll(".ingredient-qty").addEventListener("input", window.ingredientQty);
				document.querySelectorAll(".ingredient-categories").addEventListener("change", window.ingredientCategory);
				document.querySelectorAll(".ingredient-delete").addEventListener("click", window.ingredientDelete);
				document.querySelectorAll(".edit-meal-name").addEventListener("click", window.changeMealName);
				document.querySelectorAll(".meal-delete").addEventListener("click", window.deleteMeal);
				
				document.querySelectorAll(".add-ingredient").addEventListener("click", window.addIngredient);
			})
			.then(_=>{
				document.querySelector("button.create-meal").addEventListener("click", function(e){
					if(data.meals.last().name.format() !== 'Something'){
						data.meals.add(new Meal({name: 'Something', ingredients: new IngredientList(new Ingredient("Something", 0, 4))}))
						e.target.p().querySelector("#meals").append(data.meals.last().render());
						const el = document.querySelector("#meals .meal-container:last-child");

						el.querySelector(".ingredient>p[contenteditable]").addEventListener("input", window.ingredientName);
						el.querySelector(".ingredient-qty").addEventListener("input", window.ingredientQty);
						el.querySelector(".ingredient-categories").addEventListener("change", window.ingredientCategory);
						el.querySelector(".ingredient-delete").addEventListener("click", window.ingredientDelete);
						el.querySelector(".edit-meal-name").addEventListener("click", window.changeMealName);
						el.querySelector(".meal-delete").addEventListener("click", window.deleteMeal);

						el.querySelector(".add-ingredient").addEventListener("click", window.addIngredient);
					}else{alert("Please change the name of 'Something' to add another meal!")}
				})
			})

			Day.options = ()=>123

			window.log = function(){return data.meals}
		</script>-->
	</body>
</html>