<!DOCTYPE html>
<html lang="en-US">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta charset="UTF-8">
		<title>Grocery List</title>
		<style>
			:root{
				--width: 75%;
				--content-width: 85%;
				--rainbow: linear-gradient(90deg, red, orange, yellow, lime, green, lightblue, blue, purple);
				--ingredient-height: 25px;
			}
			body{font-family: 'Work Sans', sans-serif;}
			.toggles{
				display: flex;
				justify-content: center;
				flex-direction: column;
			}
			.divider{
				width: var(--width);
				height: 2px;
				background-image: var(--rainbow);
				margin: 0 auto;
			}
			.toggle-title, .meal{
				color: #444;
				cursor: pointer;
				padding: 20px 20px 10px 20px;
				width: var(--width);
				outline: none;
				margin: auto;
			}
			.toggle-title:not(.meal):after{
				content: '\02795';
				font-size: 13px;
				color: #777;
				float: right;
				margin-left: 5px;
			}
			.toggle-body{
				margin: auto auto 10px auto;
				width: var(--content-width);
				background-color: white;
				display: none;
				outline: 1px solid grey;
				overflow: hidden;
				padding: 5px;
			}
			.active:after{content: "\2796";}

			.banner-button{
				width: 100%;
				height: 60px;
				border-radius: 3px;
				text-align: center;
				margin: 0 auto;
			}
			.create-meal{
				border: 2px solid rgb(255, 140, 0);
				background-color: rgba(255, 140, 0, 0.228);
			}
			.ingredients{
				margin: 20px 0;
			}
			.ingredient, .ingredient-right{
				display: flex;
				flex-wrap: nowrap;
				justify-content: space-between;
			}
			.ingredient, .ingredient>p{
				min-height: var(--ingredient-height);
			}
			.ingredient-right{
				justify-content: flex-end;
				width: 50%;
			}
			input{
				width: 15%;
			}
			select{
				width: 20%;
				flex-grow: 1;
				
			}
			.ingredient>p{
				width: 30%;
				flex-grow: 1;
				font-size: 13px;
				margin: calc(var(--ingredient-height) / 4) 10px;
			}

			.meal-container{
				margin: 5px;
				padding: 5px;
				outline: 1px solid black;
			}


			.inline{display: inline;}
		</style>
	</head>
	<body>
		<main>
			<section class="toggles">
				<div id="meals-container">
					<h2 class="toggle-title">Meals</h2>
					<div class="toggle-body">
						<div id="meals">

						</div>
						<button class="banner-button create-meal">
							<h4>New Meal</h4>
						</button>
					</div>
				</div>
				<div class="divider"></div>
				<div id="meal-plan-container">
					<h2 class="toggle-title">Menu Plan</h2>
					<div class="toggle-body">
						<p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit saepe sequi, illum facere
							necessitatibus cum aliquam id illo omnis maxime, totam soluta voluptate amet ut sit ipsum
							aperiam.
							Perspiciatis, porro!</p>
					</div>
				</div>
				<div class="divider"></div>
				<div id="grocery-list-container">
					<h2 class="toggle-title">Grocery List</h2>
					<div class="toggle-body">
						<p>Lorem ipsum dolor, sit amet consectetur adipisicing elit. Velit saepe sequi, illum facere
							necessitatibus cum aliquam id illo omnis maxime, totam soluta voluptate amet ut sit ipsum
							aperiam.
							Perspiciatis, porro!</p>
					</div>
				</div>
			</section>
		</main>
		<script type="module">
			import {source as s, render, template} from 'https://unpkg.com/@lcf.vs/dom-engine@5.5.4/lib/frontend.js';
			String.prototype.format = function(){return this.trim().split(" ").map(word=>`${word[0].toUpperCase()}${word.substring(1)}`).join(" ")};
			NodeList.prototype.addEventListener = function(event, func){return [...this].map(node=>node.addEventListener(event, func))};
			Node.prototype.p = function(){return this.parentNode};
			
			class Item{
				constructor(name, qty, cat){
					this.name = name; 
					this.qty = qty;
					this.category = typeof cat === 'number' ? Item.categories[cat] : cat;
				}
				serialize(){return {...this, category: typeof this.category == 'number' ? this.category : Item.categories.indexOf(this.category)}}
				render(){
					return render({
						[s]: `<div class="ingredient">
							<p contenteditable>${this.name}</p>
							<div class="ingredient-right">
								<input type="number" value="${this.qty}"></input>
								<select class="ingredient-categories">
									<option class="ingredient-category" disabled>-- ${this.name} --</option>
									{categories}
								</select>
								<button class="ingredient-delete">ðŸ—‘</button>
							</div>
						</div>`,
						categories: Item.categories.map((c,i)=>render({
							[s]: `<option class="ingredient-category" ${Item.categories.indexOf(this.category) == i ? 'selected ' : ''}value="${c}">${c}</option>`
						}))
					})
				}
				static categories = ["Dry", "Produce", "Deli", "Frozen", "Other"];
			}
			class Meal{
				constructor({name, ingredients}, index = null){
					this.name = name; 
					this.ingredients = ingredients;
					this.i = index;
				}
				serialize(){return {name: this.name, ingredients: this.ingredients.serialize()}}
				render(){
					console.log(this.ingredients)
					return render({
						[s]: `<div class="meal-container" data-meal-name="{name}" data-meal-index="{?index}">
							<h3 class="toggle-title meal inline" contenteditable="false">{name}</h3>
							<span class="edit-meal-name inline">&#9998;</span>
							<div class="ingredients">
								{ingredients}
								</div>
							<button class="banner-button"><p>Add Ingredient</p></button>
						</div>`,
						name: this.name, index: this.i,
						ingredients: this.ingredients.ingredients.map(i=>i.render()),
					})
				}
			}
			class IngredientList{
				constructor(...ingredients){this.ingredients = ingredients}
				getQty(name){return this.ingredients.find(i=>i.name.format() === name.format()).qty}
				add(ingredient, _=0){(_ = this.ingredients.reduce((p,c,i)=>c.name.format() === ingredient.name.format() ? i : p, 0)) ? this.ingredients[_].qty += ingredient.qty : this.ingredients.push(ingredient)}
				remove(name, _=0){return (_ = this.ingredients.reduce((p,c,i)=>c.name.format() === name.format() ? i : p, 0) ? this.ingredients.splice(_, 1) : null, this.ingredients)}
				serialize(){return this.ingredients.map(i=>i.serialize())}
			}


			// ========= TEST DATA =============
			const things = {meals: [
				new Meal({name: "Pesto Pasta", ingredients: new IngredientList(new Item("Pasta", 1, 0), new Item("Spinach", 0.5, 1), new Item("Pesto", 0.5, 0), new Item("Pepper", 1, 1), new Item("Olives", 0.5, 0))}),
				new Meal({name: "Lentil Pasta", ingredients: new IngredientList(new Item("Pasta", 1, 0), new Item("Carrot", 1, 1), new Item("Lentil", 1, 0))}),
				new Meal({name: "A really really really really really long meal name", ingredients: new IngredientList(new Item("A really really really really long ingredient name", 1))})
			], plan: [], list: new Set()};
			window.localStorage.setItem("meal_plan_data", JSON.stringify({plan: things.plan, list: [...things.list], meals: things.meals.map(m=>m.serialize())}));
			// ========= TEST DATA =============

			for(const sect of document.querySelectorAll(".toggle-title")){
				sect.addEventListener("click", _=>{
					sect.classList.toggle("active");
					(_ = sect.nextElementSibling).style.display = _.style.display === 'block' ? 'none' : 'block';
				})
			}

			let data = JSON.parse(window.localStorage.getItem("meal_plan_data") ?? {meals: [], plan: [], list: new Set()});

			await new Promise(r=>(null,r((function renderKnown(_){
				return data = Object.assign(data, {
					meals: data.meals.map((meal, i)=>new Meal({...meal, ingredients: new IngredientList(...meal.ingredients.map(i=>new Item(...Object.values(i))))}, i)),
					list: new Set(data.list)
				})
			})(null))))
			.then(_=>_.meals.forEach(m=>document.querySelector("#meals").append(m.render())))
			.then(_=>{
				(function setupListeners(_){
					document.querySelectorAll(".ingredient-delete").addEventListener("click", _=>
						confirm(`Are you sure you want to remove ${(_ = _.target.p().p()).firstElementChild.textContent} from ${_.p().p().dataset.mealName} ingredient list?`) ? (_=>
							(_.remove(), null)
						)(_) : null);
				})(_)
			})
		</script>
	</body>
</html>